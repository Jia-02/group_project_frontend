<h2 mat-dialog-title>
  {{ data.settingName }}
  <button (click)="dialogRef.close()">
    <mat-icon>close</mat-icon>
  </button>
</h2>

<mat-dialog-content>
  <img [src]="data.settingImg" alt="{{ data.settingName }}">
  <span>NT$ {{ data.settingPrice }}</span>

  <mat-stepper orientation="vertical" [linear]="isLinear" #stepper>

    @if (data.settingDetail.length) {
      @for (categoryGroup of data.settingDetail; track categoryGroup.categoryId) {

        <mat-step [label]="categoryGroup.categoryType" [completed]="isCategoryValid(categoryGroup.categoryId)">

          <h3>選擇 {{ categoryGroup.categoryType }}</h3>

          @for (productGroup of categoryGroup.detailList; track productGroup.productId) {
            <h4>
              <input type="radio" [name]="'mainProduct_' + categoryGroup.categoryId"
                     [checked]="selectedMainProduct.get(categoryGroup.categoryId) === productGroup.productId"
                     (change)="handleMainProductChange(categoryGroup, productGroup)">
              {{ productGroup.productName }} (單點價格: {{ productGroup.productPrice }})<br>
              過敏原:
              @if(productGroup.productNote.length > 0){
                {{ productGroup.productNote }}
              } @else {
                無
              }
            </h4>
          }

          @for (optionGroup of categoryGroup.optionList; track optionGroup.optionId) {
            @if (isCategoryValid(categoryGroup.categoryId)) {
              <div class="option-group">
                <p>{{ optionGroup.optionName }} 最多選擇 {{ optionGroup.maxSelect }} 項</p>
                @for (optionItem of optionGroup.optionDetail; track optionItem.option) {
                  @if (currentSelections.get(categoryGroup.categoryId)?.get(optionGroup.optionId); as selectedSet) {
                    <label>
                      @if (optionGroup.maxSelect > 1) {
                        <input type="checkbox" [checked]="selectedSet.has(optionItem.option)"
                        [disabled]="!selectedSet.has(optionItem.option) && selectedSet.size >= optionGroup.maxSelect"
                        (change)="toggleOption(categoryGroup.categoryId, optionGroup.optionId, optionItem.option)">

                      } @else {
                        <input type="radio" [name]="'opt_' + categoryGroup.categoryId + '_' + optionGroup.optionId"
                        [checked]="selectedSet.has(optionItem.option)"
                        (change)="selectRadio(categoryGroup.categoryId, optionGroup.optionId, optionItem.option)">
                      }
                      {{ optionItem.option }} (+NT$ {{ optionItem.addPrice }})
                    </label>
                    <br>
                  }
                }
              </div>
            }
          }

          <div class="stepper-actions">
            <button mat-button matStepperPrevious>上一步</button>
            <button mat-button matStepperNext [disabled]="!isCategoryValid(categoryGroup.categoryId)">下一步</button>
          </div>

        </mat-step>
      }
    }

    <mat-step label="數量與結帳">
      <ng-template matStepLabel>確認數量與結帳</ng-template>
    </mat-step>

  </mat-stepper>

</mat-dialog-content>

<mat-dialog-actions>
  <button (click)="decrementQuantity()"><mat-icon>remove</mat-icon></button>
  <input type="number" [(ngModel)]="quantity" min="1" class="numberCss">
  <button (click)="incrementQuantity()"><mat-icon>add</mat-icon></button>
</mat-dialog-actions>

<mat-dialog-actions>
  <h3>總價格: NT$ {{ currentPrice }}</h3>
  <button [disabled]="!quantity || quantity <= 0 || !isSelectionComplete" (click)="addToCart()" class="buttonCss">
    加入購物車
  </button>
</mat-dialog-actions>
