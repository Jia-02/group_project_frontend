<button class="closeBtn" (click)="dialogRef.close()">
  <mat-icon>close</mat-icon>
</button>

<mat-dialog-content class="dialogContent">
  <img [src]="data.settingImg" alt="{{ data.settingName }}" class="heroImage">

  <div class="productInfoSection">
    <div class="productHeader">
      <h3 class="productTitle">{{ data.settingName }}</h3>
      <div class="basePrice">NT$ {{ data.settingPrice }}</div>
    </div>
    <p class="productDesc" style="margin-bottom: 0;">精選套餐組合</p>
  </div>

  <div class="customizationSection">
    @for (categoryGroup of data.settingDetail; track categoryGroup.categoryId) {
      <h3 class="sectionTitle">選擇 {{ categoryGroup.categoryType }}</h3>

      <div class="optionGroup">
        <div class="optionList">
          @for (productGroup of categoryGroup.detailList; track productGroup.productId) {
            <label class="optionRow">
              <div class="inputWrapper">
                <input type="radio"
                       [name]="'mainProduct_' + categoryGroup.categoryId"
                       class="nativeInput"
                       [checked]="selectedMainProduct.get(categoryGroup.categoryId) === productGroup.productId"
                       (change)="handleMainProductChange(categoryGroup, productGroup)">
              </div>
              <span class="optName">
                {{ productGroup.productName }}
                <small style="color: #888; font-weight: 400; margin-left: 4px;">(單點: {{ productGroup.productPrice }})</small>
              </span>
            </label>
          }
        </div>
      </div>

      @for (optionGroup of categoryGroup.optionList; track optionGroup.optionId) {
        <div class="optionGroup">
          <div class="groupHeader">
            <span class="groupName">{{ optionGroup.optionName }}</span>
            <span class="groupLimit">(最多選 {{ optionGroup.maxSelect }} 項)</span>
          </div>

          <div class="optionList">
            @for (optionItem of optionGroup.optionDetail; track optionItem.option) {
              @if (currentSelections.get(categoryGroup.categoryId)?.get(optionGroup.optionId); as selectedSet) {
                <label class="optionRow">
                  <div class="inputWrapper">
                    @if (optionGroup.maxSelect > 1) {
                      <input type="checkbox" class="nativeInput"
                             [checked]="selectedSet.has(optionItem.option)"
                             [disabled]="!selectedSet.has(optionItem.option) && selectedSet.size >= optionGroup.maxSelect"
                             (change)="toggleOption(categoryGroup.categoryId, optionGroup.optionId, optionItem.option)">
                    } @else {
                      <input type="radio"
                             [name]="'opt_' + categoryGroup.categoryId + '_' + optionGroup.optionId"
                             class="nativeInput"
                             [checked]="selectedSet.has(optionItem.option)"
                             (change)="selectRadio(categoryGroup.categoryId, optionGroup.optionId, optionItem.option)">
                    }
                  </div>
                  <span class="optName">{{ optionItem.option }}</span>
                  <span class="optPrice">+NT$ {{ optionItem.addPrice }}</span>
                </label>
              }
            }
          </div>
        </div>
      }
    }
  </div>
</mat-dialog-content>

<div class="footerContainer">
  <mat-dialog-actions class="quantityPanel">
    <button class="qtyBtn" (click)="decrementQuantity()">
      <mat-icon>remove</mat-icon>
    </button>
    <input type="number" [(ngModel)]="quantity" min="1" class="qtyInput" readonly>
    <button class="qtyBtn" (click)="incrementQuantity()">
      <mat-icon>add</mat-icon>
    </button>
  </mat-dialog-actions>

  <mat-dialog-actions class="cartPanel">
    <button class="addToCartBtn"
            [disabled]="!quantity || quantity <= 0 || !isSelectionComplete"
            (click)="addToCart()">
      <span class="cartText">加入購物車</span>
      <span class="totalPrice">NT$ {{ currentPrice }}</span>
    </button>
  </mat-dialog-actions>
</div>
