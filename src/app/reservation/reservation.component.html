<div class="background">
  <div class="mainLayout">

    <div class="leftPanel">

      <div class="calendarPanel">

        <!-- 行事曆 -->
        <div class="header">
          <h2 class="monthTitle">
            {{ currentMonth() | date: 'yyyy年 MM月' }}
          </h2>
          <div class="navButtons">
            <button (click)="prevMonth()" class="navButton" aria-label="上個月">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <button (click)="nextMonth()" class="navButton" aria-label="下個月">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </button>
          </div>
        </div>

        <div>
          <div class="dayNames">
            @for (dayName of dayNames; track $index) {
            <div class="dayName">
              {{ dayName }}
            </div>
            }
          </div>

          <div>
            @for (week of monthWeeks; track $index) {
            <div class="calendarWeek">
              @for (day of week; track $index) {
              <div class="calendarDays" (click)="selectDay(day)">

                <div class="dayContent" [class.is-selected]="isSameDate(day, selectedDay())"
                  [class.is-today]="isToday(day)" [class.is-other-month]="!isSameMonth(day, currentMonth())">

                  <span class="dayNumber">{{ day | date: 'd' }}</span>

                  @if (hasActivity(day)) {
                  <div class="activityDot" [class.dot-white]="isSameDate(day, selectedDay())"
                    [class.dot-blue]="!isSameDate(day, selectedDay())">
                  </div>
                  }
                </div>
              </div>
              }
            </div>
            }
          </div>
        </div>
      </div>

      @if (selectedReservationDetail()) {
      <div class="reservationDetailPanel">
        <div class="detailHeader">
          <h4 class="detailTitle">訂位詳細資訊</h4>

          @if (selectedReservationDetail() && !isReservationPast(selectedReservationDetail()!)) {
          <div class="btnBox">
            <mat-icon (click)="updateReserve()" class="updateBtn" aria-hidden="false" aria-label="Example edit icon"
              fontIcon="edit"></mat-icon>
            <mat-icon (click)="deleteReserve()" class="deleteBtn" aria-hidden="false" aria-label="Example delete icon"
              fontIcon="delete"></mat-icon>
          </div>
          }

        </div>
        <div class="detailContent">
          <p><strong>顧客姓名:</strong> {{ selectedReservationDetail()!.reservationName }}</p>
          <p><strong>聯絡電話:</strong> {{ selectedReservationDetail()!.reservationPhone }}</p>
          <hr>
          <p><strong>預約日期:</strong> {{ selectedReservationDetail()!.reservationDate }}</p>
          <p><strong>預約時段:</strong> {{ selectedReservationDetail()!.reservationTime }} ~ {{
            selectedReservationDetail()!.endTime }}</p>
          <p><strong>桌位編號:</strong> {{ selectedReservationDetail()!.tableId }}</p>
          <hr>
          <p><strong>總人數:</strong> {{ selectedReservationDetail()!.reservationCount }} 人</p>
          <p><strong>&nbsp;&nbsp; - 成人:</strong> {{ selectedReservationDetail()!.reservationAdultCount }} 人</p>
          <p><strong>&nbsp;&nbsp; - 兒童:</strong> {{ selectedReservationDetail()!.reservationChildCount }} 人</p>
          @if (selectedReservationDetail()!.childSeat > 0) {
          <p><strong>&nbsp;&nbsp; - 兒童座椅:</strong> {{ selectedReservationDetail()!.childSeat }} 張</p>
          }
          @if (selectedReservationDetail()!.reservationNote) {
          <p class="note"><strong>備註:</strong> {{ selectedReservationDetail()!.reservationNote || '無' }}</p>
          }
        </div>


      </div>
      }
    </div>


    <!-- 右側當日狀態 -->
    <div class="schedulePanel">
      <div class="rightPanelWrapper">

        <!-- 固定日期區 -->
        <div class="scheduleHeader">
          <h3 class="scheduleTitle">
            {{ selectedDay() | date: 'yyyy年 MM月 dd日' }} ({{ getDayName(selectedDay()) }})
          </h3>

        </div>

        <!-- 主要可滾動區：桌號 + 時間軸 + 訂位 -->
        <div class="scheduleScrollArea">

          <div class="table-header-row"
            [style.grid-template-columns]="'var(--time-label-width) repeat(' + tables().length + ', minmax(110px, 1fr))'">

            <div class="time-label-spacer"></div>

            @for (table of tables(); track table.table_id) {
            <div class="tableHeader">
              <span class="tableName" [class.text-muted]="table.table_status !== true">
                {{ table.table_id }}
                <span style="font-size: 12px">({{ table.capacity }}人)</span>
              </span>

              <!-- 桌位開關按鈕 -->
              <label class="toggleSwitch" title="切換開放狀態">
                <input type="checkbox" [checked]="table.table_status == true" (change)="tableAvailabe(table)">
                <span class="slider round"></span>
              </label>
            </div>
            }
          </div>

          <!-- 時間網格 + 訂位圖層 -->
          <div class="timeGrid"
            [style.grid-template-columns]="'var(--time-label-width) repeat(' + tables().length + ', minmax(110px, 1fr))'">

            <!-- 時間軸 -->
            @for (label of timeLabels; track label.time) {
            <div class="timeLabelCell" [ngClass]="{ 'isNotAllowed': !isAllowedHour(label.hour),
              'isPastDay': isPastDay() || (isToday(selectedDay()) && isPastHourSlot(label.hour))
            }">
              {{ label.display }}</div>

            @for (table of tables(); track table.table_id) {
            <div class="hourSlot"
              [class.isUnavailable]="table.table_status !== true"
              [class.isNotAllowed]="!isAllowedHour(label.hour)"
              [class.isPastDay]="isPastDay() || (isToday(selectedDay()) && isPastHourSlot(label.hour))"
              [title]="(table.table_status !== true) ? '桌位已關閉' :
             (!isAllowedHour(label.hour)) ? '非預約時段' :
             (isPastDay() || (isToday(selectedDay()) && isPastHourSlot(label.hour))) ? '時段已過' :
             '點擊新增訂位'"
              (click)="!(isPastDay() || (isToday(selectedDay()) && isPastHourSlot(label.hour))) && addReservation(table.table_id, label.hour)">
            </div>
            }
            }
            <!-- 活動層 -->
            <div class="activitiesLayer"
              [style.grid-template-columns]="'var(--time-label-width) repeat(' + tables().length + ', minmax(110px, 1fr))'">

              @for (reserveData of currentDayReserve(); track $index) {
              <div class="activityBlock" [style.top.px]="getTopPosition(reserveData.reservationTime)"
                [style.height.px]="getHeight(reserveData.useTime)" [style.grid-column]="getTableGridColumn(reserveData)"
                title="{{ reserveData.reservationName }}" (click)="showReservationDetail(reserveData)">


                <div class="activityContent">
                  <span class="customerName">{{ reserveData.reservationName }}</span>
                  <span class="customerName">{{ reserveData.reservationPhone }}</span>
                  <span class="tableTime">{{ reserveData.reservationTime }} - {{ reserveData.endTime }}</span>
                </div>
              </div>
              }
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>
