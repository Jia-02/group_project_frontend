<div class="calendar-container">

  <div class="header">
    <button (click)="prevMonth()">⬅</button>
    <h3>{{ currentMonth | date: 'yyyy年 MMM' }}</h3>
    <button (click)="nextMonth()">⮕</button>
  </div>

  <div class="display">
    <!-- ======= 月曆區 ======= -->
    <div class="calendar-wrapper">
      <table class="calendar-table">
        <thead>
          <tr>
            @for (dayName of dayNames; track $index) {
            <th>{{ dayName }}</th>
            }
          </tr>
        </thead>
        <tbody>
          @for (week of monthWeeks; track $index) {
          <tr class="calendar-week">
            @for (day of week; track $index) {
            <td class="calendar-day" [class.is-current-month]="day && (day | date:'MM') === (currentMonth | date:'MM')"
              [class.selected-day]="selectedDay && day && (day | date:'yyyy-MM-dd') === (selectedDay | date:'yyyy-MM-dd')"
              (click)="selectDay(day)">
              @if (day) {
              <span class="day-number">{{ day | date:'d' }}</span>
              <div class="activity-bar-container">
                @for (act of getDayActivities(day); track act.calendarId) {
                <div class="activity-bar" [class.multi-day]="isMultiDay(act)"
                  [title]="act.calendarTitle + ' (' + act.calendarStatus + ')'"
                  [ngClass]="{'activity-published': act.calendarStatus === 'published', 'activity-draft': act.calendarStatus === 'draft'}">
                  @if (isActivityStartDay(act, day) || !isMultiDay(act)) {
                  <span class="activity-title">{{ act.calendarTitle }}</span>
                  }
                </div>
                }
              </div>
              }
            </td>
            }
          </tr>
          }
        </tbody>
      </table>
    </div>

    <div>
      <!-- 新增活動 -->
      <div class="sidebar-card">
        <h3>新增活動</h3>
        <div class="sidebar-line"></div>
        <label>活動標題:<input type="text" [(ngModel)] = "calendarTitle"></label><br>
        <label>活動內容：</label>
        <textarea [(ngModel)]="calendarDescription" rows="3"></textarea><br>
        <label for="photo-file-input">
          <button type="button" class="file-select-button">選擇 Photo</button>
          {{ selectedPhotoFile ? selectedPhotoFile.name : '未選擇檔案' }}
          <input type="file" accept="image/*" id="photo-file-input" (change)="onFileSelected($event)"
            style="display: none;">
        </label><br>
        @if (photoUrl) {
        <div>
          <img [src]="photoUrl" alt="活動圖片預覽" style="max-width: 100%; max-height: 150px; margin-top: 10px;">
        </div>
        }
        <label>活動時間：</label>
        <input type="date" [(ngModel)]="calendarStartDate">~<input type="date" [(ngModel)]="calendarEndDate">
        <button (click)="openDialog()" style="margin-left: 330px;">新增活動</button>
      </div>

      <!-- 查看活動 -->
      <div class="sidebar-card">
        <h3>{{ selectedDay | date:'MM/dd' }} 的活動</h3>
        <div class="sidebar-line"></div>

        <div class="activities-content">

          @if (selectedDayActivities.length > 0) {

          <ul>
            @for (activity of selectedDayActivities; track activity.calendarId) {
            <li
              [ngClass]="{ 'detail-published': activity.calendarStatus === 'published', 'detail-draft': activity.calendarStatus === 'draft' }"
              class="activity-item" (click)="openActivity(activity)">
              <strong>{{ activity.calendarTitle }}</strong><br>
              <span>{{ activity.calendarDescription }}</span><br>
              <small>
                {{ activity.calendarStartDate | date:'MM/dd' }}-{{ activity.calendarEndDate | date:'MM/dd' }}
              </small>
            </li>
            }
          </ul>

          } @else {
          <p class="no-activity">本日沒有活動。</p>
          }

        </div>
      </div>

    </div>
  </div>
</div>

