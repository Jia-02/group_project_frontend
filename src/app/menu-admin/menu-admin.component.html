<div class="page">

  <!-- 左側：分類與餐點 -->
  <div class="content">

    <mat-tab-group class="category-tabs" [(selectedIndex)]="selectedTabIndex" (selectedTabChange)="onTabChange($event)">

      @for (category of allCategoryDto; track $index) {
      <mat-tab>

        <ng-template mat-tab-label>
          <div class="tab-label">
            <span>{{ category.categoryType }}</span>

            <button mat-icon-button (click)="updateCategory(category); $event.stopPropagation()">
              <mat-icon>edit</mat-icon>
            </button>

            <button mat-icon-button color="warn" (click)="delCategory(category); $event.stopPropagation()">
              <mat-icon>remove</mat-icon>
            </button>
          </div>
        </ng-template>


        <!-- 套餐 -->
        @if (category.categoryType === '套餐') {
        <div class="card-grid">

          @for (pkg of setList; track $index) {
          <div class="card package-card">

            <img [src]="pkg.settingImg || 'assets/default-package.jpg'">

            <div class="card-body">
              <div class="card-title">{{ pkg.settingName }}</div>
              <div class="price">${{ pkg.settingPrice }}</div>

              <div class="note">{{ pkg.settingNote }}</div>

              <div class="package-detail">
                @for (group of pkg.settingDetail; track $index) {
                <div class="detail-row">
                  <span class="tag category">
                    {{ getCategoryName(group.categoryId) }}
                  </span>
                  @for (item of group.detailList; track $index) {
                  <span class="tag product">
                    {{ item.productName || item.productId }}
                  </span>
                  }
                </div>
                }
              </div>
            </div>

            <div class="card-footer">
              <mat-slide-toggle [(ngModel)]="pkg.settingActive" (change)="launchSet(pkg)">
                上架
              </mat-slide-toggle>

              <button mat-icon-button [matMenuTriggerFor]="pkgMenu">
                <mat-icon>more_vert</mat-icon>
              </button>

              <mat-menu #pkgMenu="matMenu">
                <button mat-menu-item (click)="updateSet(pkg)">
                  <mat-icon>edit</mat-icon> 編輯
                </button>
                <button mat-menu-item (click)="delSet(pkg)">
                  <mat-icon>delete</mat-icon> 刪除
                </button>
              </mat-menu>
            </div>

          </div>
          }

          <div class="card add-card" (click)="addSets()">＋ 新增套餐</div>
        </div>
        }

        <!-- 一般餐點 -->
        @else {
        <div class="card-grid">

          @for (product of productList; track $index) {
          <div class="card">

            <img [src]="product.imageUrl">

            <div class="card-body">
              <div class="card-title">{{ product.productName }}</div>
              <div class="note">{{ product.productDescription }}</div>
              <div class="price">${{ product.productPrice }}</div>
            </div>

            <div class="card-footer">
              <mat-slide-toggle [(ngModel)]="product.productActive" (change)="launchProduct(product)">
                上架
              </mat-slide-toggle>

              <button mat-icon-button [matMenuTriggerFor]="menu">
                <mat-icon>more_vert</mat-icon>
              </button>

              <mat-menu #menu="matMenu">
                <button mat-menu-item (click)="updateProduct(product)">
                  <mat-icon>edit</mat-icon> 編輯
                </button>
                <button mat-menu-item (click)="delProduct(product)">
                  <mat-icon>delete</mat-icon> 刪除
                </button>
              </mat-menu>
            </div>

          </div>
          }

          <div class="card add-card" (click)="addProduct()">＋ 新增餐點</div>
        </div>
        }

      </mat-tab>
      }

      <!-- 新增分類 Tab -->
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>add</mat-icon>
        </ng-template>

        <div class="add-category-form">
          <h3>新增分類</h3>

          <label>分類名稱</label>
          <input [(ngModel)]="categoryDto.categoryType">

          <label>工作檯</label>
          <select [(ngModel)]="categoryDto.workstationId">
            <option value="">請選擇</option>
            <option [ngValue]="1">飲品區</option>
            <option [ngValue]="2">熱食區</option>
          </select>

          <button (click)="addCategory()">建立分類</button>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>

  <!-- 右側：客製化 -->
  @if (currentCategoryId > 0) {
  <aside class="customize-sidebar">

    <div class="sidebar-title">客製化選項</div>

    @for (option of optionList; track $index) {
    <div class="customize-group">

      <div class="customize-header">
        <span>{{ option.optionName }}</span>
        <div>
          <mat-icon (click)="updateCustomized(option)">edit</mat-icon>
          <mat-icon (click)="delCustomized(option)">delete</mat-icon>
        </div>
      </div>

      @for (detail of option.optionDetail; track $index) {
      <label class="customize-item">
        <input type="radio">
        {{ detail.option }}
        @if (detail.addPrice > 0) {
        <span class="extra">+ ${{ detail.addPrice }}</span>
        }
      </label>
      }
    </div>
    }

    <button class="add-customize" (click)="addCustomized()">＋ 新增客製化</button>
  </aside>
  }

</div>
